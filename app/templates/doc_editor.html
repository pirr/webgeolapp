{% extends "doc_base.html" %}
{% block script %}
<script type="text/javascript">
function postDataDoc() {
    var features_pis_id = new Array();
    var doc_name = $('#doc_name:input').val();
    var doc_lon = $('#doc_lon:input').val();
    var doc_lat = $('#doc_lat:input').val();
    var source_type_id = $('#source_type:checked').val();
    $('#features_pis:checked').each(function(){
        features_pis_id[features_pis_id.length] = $(this).val()
    });
    console.log(features_pis_id, doc_name, source_type_id);
    $.ajax({
        type: 'POST',
        url: '/doc_edit_post/{{doc.id}}',
        data: JSON.stringify({features_pis_id:features_pis_id,
                            name:doc_name,
                            lon:doc_lon,
                            lat:doc_lat,
                            source_type_id:source_type_id}),
        success: function(response) {
            if (response=='Err') 'Err';
            else location.reload();
        }
    });
}
function canselEdit() {
    location.reload();
}
</script>
{% endblock %}

{% block leftnav %}
<li><a>Документ №<b>{{doc.id}}</b> Название: <b>{{doc.name}}</b></a></li>
{% endblock %}
{% block nav %}
<button class="btn btn-default navbar-btn" type="button" onclick="postDataDoc()">Сохранить изменения</button>
<button class="btn btn-default navbar-btn" type="button" onclick="canselEdit()"
>Отменить изменения</button>
{% endblock %}

<div class="container">
{% block body %}
    <table class="table table-bordered">
    <caption>Данные документа</caption>
    <tr>
        <td>Название по документу:</td><td><input type="text" class="form-control" value="{{doc.name}}" id="doc_name"></td>
     <!-- map -->
    <td align="center" width="20%" rowspan="5">
        <div id="map" style="width: 400px; height: 300px"></div>
            <script type="text/javascript">
                console.log('MAP!')
                var map = L.map('map').setView([{{coord.lat}},{{coord.lon}}], 10);
                
                L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    id: 'examples.map-i875mjb7'
                }).addTo(map);
            
                L.marker([{{coord.lat}},{{coord.lon}}]).addTo(map)
                    .bindPopup('<input type="text" class="form-control" value = {{coord.lat}} id="doc_lat"></br>'+
                        '<input type="text" class="form-control" value = {{coord.lon}} id="doc_lon">', {maxWidth: 300, minWidth: 250, maxHeight: 160, autoPan: true, closeButton: true, autoPanPadding: [5, 5]}).openPopup();

                var popup = L.popup();

                function onMapClick(e) {
                    popup
                        .setLatLng(e.latlng)
                        .setContent(e.latlng.toString())
                        .openOn(map);
                }
                map.on('click', onMapClick);
                L.control.fullscreen().addTo(map);
                L.control.scale().addTo(map);
            </script>
    </tr>
    <tr><td>Вид документа регистрации:</td>
    <td>
        <select class="form-control">
        <option id="source_type" value="{{source_type.id}}">{{source_type.name}}</option>
        {% for source in sources_type %}
        <option id="source_type" value="{{source.id}}">{{source.name}}</option>
        {% endfor %}
        </select>
    </td>
    </tr>
    <tr><td>Орган регистрации:</td><td></td></tr>
    <tr><td>Субъект РФ:</td><td></td></tr>
    <tr><td>Административный район:</td><td></td></tr>
    <tr>
        <td>Входимость в объект (группу):</td>
            <td colspan="2">
                <script type="text/javascript">
                    html_response('/docs_in_obj/{{doc.id}}', '#docs')
                </script>
                <div id="docs"></div>
        </td>
    <tr>
        <td>Полезные ископаемые: </td>
        <td>
        {% for pi in pis %}
        {}
    </table>
    <table class="table table-bordered">

    <caption>Запасы</caption>
    <tr>
        <td>Полезное ископаемое</td><td>Группа ПИ в госпрограмме</td><td>АBC1</td><td>C2</td><td>Документ утверждения запасов</td><td>Номер</td><td>Дата</td><td>Организация</td>
    </tr>

    <tr>
    {% for pi in pis %}
    <tr>
        <td>
        <select class="form-control">
        <option id="features_pis" value="{{pi.pi_id}}">{{pi.pi}}</option>
        {% for pi in dic_pi %}
        <option id="features_pis" value="{{pi.pi_id}}">{{pi.pi}}</option>
        {% endfor %}
        </select>
        </td>
        <td>
        {{pi.type_pi}}
        </td>
        <td></td><td></td><td>
        </td><td></td><td></td><td></td>
        <td><button class="btn btn-xs btn-danger" id="piDel" value="{{pi.pi_id}}">удалить</button>
        </td>
    </tr>
    {% endfor %}
    </tr>
    <tr>
        <td>
        <select class="form-control">
        {% for pi in dic_pi %}
        <option id="features_pis" value="{{pi.pi_id}}">{{pi.pi}}</option>
        {% endfor %}
        </select>
        </td>
        <td colspan="10"><button id="piAdd" class="btn btn-success">+ Добавить полезное ископаемое</button></td>
    </tr>
    </table>

    <table  class="table table-bordered">
    <caption>Прогнозные ресурсы</caption>
    <tr>
        <td>Полезное ископаемое</td><td>Группа ПИ в госпрограмме</td><td>P1</td><td>P2</td><td>P3</td>
        <td>Без категории</td><td>Документ апробации</td><td>Номер</td><td>Дата</td><td>Организация</td>
    </tr>
    
    <tr>
    {% for pi in pis %}
    <tr>
        <td>
        <select class="form-control">
        <option id="features_pis" value="{{pi.pi_id}}">{{pi.pi}}</option>
        {% for pi in dic_pi %}
        <option id="features_pis" value="{{pi.pi_id}}">{{pi.pi}}</option>
        {% endfor %}
        </select>
        </td>
        <td>
        {{pi.type_pi}}
        </td>
        <td></td><td></td><td></td><td></td>
        <td></td><td></td><td></td><td></td>
        <td><button class="btn btn-xs btn-danger" id="piDel" value="{{pi.pi_id}}">удалить</button>
        </td>
    </tr>
    {% endfor %}
    </tr>
    <tr>
        <td>
        <select class="form-control">
        {% for pi in dic_pi %}
        <option id="features_pis" value="{{pi.pi_id}}">{{pi.pi}}</option>
        {% endfor %}
        </select>
        </td>
        <td colspan="10"><button id="piAdd" class="btn btn-success">+ Добавить полезное ископаемое</button></td>
    </tr>
    </table>
    
</div>


{% endblock %}


